{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020/01/how-to-implement-safetynet-attestation-in-your-application/","result":{"data":{"markdownRemark":{"html":"<p>This post is just a collection of information about how to implement\n<a href=\"https://developer.android.com/training/safetynet/attestation\">SafetyNet Attestation\nAPI</a> in\nyour application.</p>\n<p>This whole thing started weeks ago after my team was researching a way\nto block suspicious requests that were occurring in our authentication\nAPI. There were lots of different users trying to log in, from different\nIP addresses/ranges. We already had a\n<a href=\"https://en.wikipedia.org/wiki/Web_application_firewall\">WAF</a> set up,\nhowever, in this scenario, this was not effective. We think that there\nhad been a data breach with lots of users and passwords, therefore,\nattackers were using these information to try a <em>lucky guess</em> in our\nAPI, almost like a brute-force attack.</p>\n<p>Our first attempt was to use\n<a href=\"https://developer.android.com/training/safetynet/recaptcha\">reCAPTCHA</a>\nas our mechanism to block those requests. However, we've found that user\nexperience using this mechanism was really bad, as reCAPTCHA is an\nintrusive approach (even though it has an invisible option). After some\nresearch, we decided to give a try to use SafetyNet Attestation API.</p>\n<h2>How SafetyNet Attestation API replaces reCAPTCHA?</h2>\n<p>In our scenario, the problem we were trying to solve was to separate\nmalicious attacks from real login attempts from our clients. In other\nwords, we wanted to know if a login attempt was occurring from an\nautomation script or from a <em>real</em> device.</p>\n<p>Therefore, when we know we have a <em>real</em> device, we allow the user to\nlog in, otherwise, we just block the request.</p>\n<h2>SafetyNet Attestation API implementation: device</h2>\n<p>I'll not get into lots of details about the device implementation,\nhowever, it's pretty straightforward:\n<a href=\"https://developer.android.com/training/safetynet/attestation#request-attestation-step\">https://developer.android.com/training/safetynet/attestation#request-attestation-step</a>.</p>\n<h2>SafetyNet Attestation API implementation: token verification</h2>\n<p>First and foremost, you need to have in mind that the token verification\n<strong>is up to you</strong>. There are some tutorials and even a <a href=\"https://github.com/googlesamples/android-play-safetynet/blob/d7513a54e2f28c0dcd7f8d8d0fa03adb5d87b91a/server/csharp/OnlineVerify.cs#L45-L46\">code in google\nsamples</a>\nthat verifies the token for you using an online API. However, this\nshould <strong>not be your production approach</strong>.</p>\n<p>In order to verify the token, we must first understand what this token\nrepresents. The token is a\n<a href=\"https://tools.ietf.org/html/draft-ietf-jose-json-web-signature-36\">JWS</a>\ntoken. If you want, you'll be able to parse this token using simple\n<code class=\"language-text\">jwt</code> tools. For example, one may use <a href=\"https://jwt.io/\">https://jwt.io/</a> debugger to get\nthe token information, or use any standard <code class=\"language-text\">jwt</code> implementation.</p>\n<p>A valid SafetyNet token will have a header that looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"alg\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"RS256\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"x5c\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"signing certificate as base64 goes here\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"issuer certificate as base64 goes here\"</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And it will have a payload that looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"timestampMs\"</span><span class=\"token operator\">:</span> <span class=\"token number\">9860437986543</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"nonce\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"R2Rra24fVm5xa2Mg\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"apkPackageName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"com.package.name.of.requesting.app\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"apkCertificateDigestSha256\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\"base64 encoded<span class=\"token punctuation\">,</span> SHA<span class=\"token number\">-256</span> hash of the\n                                  certificate used to sign requesting app\"<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ctsProfileMatch\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"basicIntegrity\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If you want, you can have the payload representation as follows (in\nGo):</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// Attestation response from Google SafetyNet Attestation API</span>\n<span class=\"token keyword\">type</span> Attestation <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\tTimestampMs                <span class=\"token builtin\">int64</span>    <span class=\"token string\">`json:\"timestampMs\"`</span>                <span class=\"token comment\">// time when response was generated by Google's servers</span>\n\tNonce                      <span class=\"token builtin\">string</span>   <span class=\"token string\">`json:\"nonce\"`</span>                      <span class=\"token comment\">// single use token</span>\n\tApkPackageName             <span class=\"token builtin\">string</span>   <span class=\"token string\">`json:\"apkPackageName\"`</span>             <span class=\"token comment\">// calling app's package name</span>\n\tApkCertificateDigestSha256 <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span> <span class=\"token string\">`json:\"apkCertificateDigestSha256\"`</span> <span class=\"token comment\">// base64 encoded representation of SHA-256 hash of the calling app signing certificate</span>\n\tCtsProfileMatch            <span class=\"token builtin\">bool</span>     <span class=\"token string\">`json:\"ctsProfileMatch\"`</span>            <span class=\"token comment\">// stricter veredict of device integrity</span>\n\tBasicIntegrity             <span class=\"token builtin\">bool</span>     <span class=\"token string\">`json:\"basicIntegrity\"`</span>             <span class=\"token comment\">// a more lenient veredict of device integrity</span>\n\tError                      <span class=\"token builtin\">string</span>   <span class=\"token string\">`json:\"error\"`</span>                      <span class=\"token comment\">// error occured from API request</span>\n\tAdvice                     <span class=\"token builtin\">string</span>   <span class=\"token string\">`json:\"advice\"`</span>                     <span class=\"token comment\">// suggestion on how to get device back into a good state</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now you're wondering what you should do with that information. <a href=\"https://github.com/googlesamples/android-play-safetynet/issues/21\">And\nyou're not\nalone</a>.\nThere are many pieces of information and you must decide what to use.</p>\n<p>One thing that is really important to be done is to verify if the\ntoken is valid. You can do that using standard <code class=\"language-text\">jws</code> tools. If you\nsearch for terms like <em>jws</em> and <em>jose</em> you might find some tools for\nyour preferred language. If you're using Go, you can use\n<a href=\"https://godoc.org/gopkg.in/square/go-jose.v2\"><code class=\"language-text\">go-jose</code></a>. Here goes an\nexample on how to check the validity of a JWS token:</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">Validate</span><span class=\"token punctuation\">(</span>token <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tsignedAttestation<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> jose<span class=\"token punctuation\">.</span><span class=\"token function\">ParseSigned</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error on parse signed attestation: %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>After that, you need to check if that message was signed by Google\nitself. If you saw before, we have a\n<a href=\"https://tools.ietf.org/html/draft-ietf-jose-json-web-signature-36#section-4.1.6\"><code class=\"language-text\">x5c</code></a>\nproperty on the header. This information says two things: first, who\nsigned the JWS token itself. Second, who signed the certificate that\nsigned the JWS token. In other words, it's a <a href=\"https://tools.ietf.org/html/rfc5280\">certificate\nchain</a>.</p>\n<p>There are lots of solutions for validating a certificate chain. If\nyou're using Go and <code class=\"language-text\">go-jose</code>, it's pretty straightforward to do that:</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">ValidateSafetyNetAttesationToken</span><span class=\"token punctuation\">(</span>token <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// remaining code</span>\n\n\t<span class=\"token comment\">// uses default system root CAs to validate</span>\n\topts <span class=\"token operator\">:=</span> x509<span class=\"token punctuation\">.</span>VerifyOptions<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\tcerts<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> signedAttestation<span class=\"token punctuation\">.</span>Signatures<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Header<span class=\"token punctuation\">.</span><span class=\"token function\">Certificates</span><span class=\"token punctuation\">(</span>opts<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error on validating certificates: %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now that you know that the message is really sent by Google, the next\nstep is to get its payload. The payload can be used to check device\nintegrity (for example, to check if the phone is not rooted). Here is an\nexample on how to do that:</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">ValidateSafetyNetAttesationToken</span><span class=\"token punctuation\">(</span>token <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// remaining code</span>\n\n\tattestationPayload<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> signedAttestation<span class=\"token punctuation\">.</span><span class=\"token function\">Verify</span><span class=\"token punctuation\">(</span>certs<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>PublicKey<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error on verifying attestation: %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\tattestation <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>Attestation<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n\tjson<span class=\"token punctuation\">.</span><span class=\"token function\">Unmarshal</span><span class=\"token punctuation\">(</span>attestationPayload<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>attestation<span class=\"token punctuation\">)</span>\n\n\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%+v\\n\"</span><span class=\"token punctuation\">,</span> attestation<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now, it's up to you to do whatever you want. I recommend to check if all\nthe fields match the values you expect. Some ideas:</p>\n<ul>\n<li>Verify if <code class=\"language-text\">apkCertificateDigestSha256</code> matches the fingerprint of the\ncertificate that was used to sign the app (only your team should have\nthe private key to do that)</li>\n<li>Verify if <code class=\"language-text\">apkPackageName</code> matches the package that should call the\nAttestation API</li>\n<li>Verify the value from <a href=\"https://developer.android.com/training/safetynet/attestation#potential-integrity-verdicts\"><code class=\"language-text\">basicIntegrity</code> and\n<code class=\"language-text\">ctsProfileMatch</code></a></li>\n<li>Verify if the provided timestamp is in a specific range/time limit\n(for example, consider it expired if generated 10 minutes ago)</li>\n<li>I couldn't find a practical case for using the <code class=\"language-text\">nonce</code>, however, you\ncan use it to match if the information given by the client is what you\nexpected. This, combined with some cryptography strategy, makes it\neven harder for an attacker to \"guess\" the nonce</li>\n</ul>\n<p>Hope you find it helpful!</p>","frontmatter":{"title":"How to Implement SafetyNet Attestation in Your Application","tags":["Android","SafetyNet","Attestation","ReCATPCHA Alternative","Security"]}}},"pageContext":{"slug":"/2020/01/how-to-implement-safetynet-attestation-in-your-application/","lang":"en-us"}},"staticQueryHashes":["2744905544","3000541721","3159585216"],"slicesMap":{}}