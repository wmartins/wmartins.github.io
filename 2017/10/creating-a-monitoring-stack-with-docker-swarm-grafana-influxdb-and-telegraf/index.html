<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Creating a Monitoring Stack With Docker Swarm, Grafana, InfluxDB and Telegraf - wwwhmartins</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <link rel="canonical" href="https://wmartins.github.io/2017/10/creating-a-monitoring-stack-with-docker-swarm-grafana-influxdb-and-telegraf/">

  
  

  
  

  
  

  <link rel="stylesheet" type="text/css" href="https://wmartins.github.io/css/combined-min.css">
  <link rel="stylesheet" type="text/css" href="https://wmartins.github.io/tipuesearch/tipuesearch.css">

</head>
<body class="">

<div class="site-wrap">
  <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="https://wmartins.github.io" class="site-title">wwwhmartins</a>
      <nav class="site-nav right">
      <a href="https://wmartins.github.io/about/">About</a>
<a href="https://wmartins.github.io/tags/">Tags</a>
<a href="https://wmartins.github.io/contact/">Contact</a>
</form>

      </nav>
      <div class="clearfix"></div>
    </div>
  </div>
</header>

  <div class="post p2 p-responsive wrap" role="main">
    <div class="measure">
      <div class="post-header mb2">
        <h1 class="py2">Creating a Monitoring Stack With Docker Swarm, Grafana, InfluxDB and Telegraf</h1>
        <span class="post-meta">Oct 3, 2017 by William Martins</span><br>
        
      </div>

      <article class="post-content">
      <p>Monitoring your infrastructure is one of the most important aspects of
successfully launching a product. It's really important to know when your
machines/applications are under heavy load. Moreover, if it happens, you would
want to quickly know what's going on and what you can do to recover your
infrastructure.</p>
<p>This blog post explains how you can configure setup a monitoring stack easily
using <a href="https://docs.docker.com/engine/swarm/"><strong>Docker Swarm</strong></a>,
<a href="https://github.com/grafana/grafana"><strong>Grafana</strong></a>,
<a href="https://github.com/influxdata/influxdb"><strong>InfluxDB</strong></a> and
<a href="https://github.com/influxdata/telegraf"><strong>Telegraf</strong></a>.</p>
<h2 id="docker-swarm">Docker Swarm</h2>
<p>This tutorial requires you to be running a <strong>Swarm cluster</strong>. You can also setup
this monitoring infrastructure without using Swarm, but it might become hard to
manage when you add or remove nodes on your cluster.</p>
<blockquote>
<p>You can achieve the same using another deployment/orchestration tool, like
<a href="https://www.nomadproject.io/"><strong>Nomad</strong></a>.</p>
</blockquote>
<p>We'll be using the version <strong>3.3</strong> of <code>docker-compose.yml</code> file.</p>
<h2 id="telegraf">Telegraf</h2>
<p><a href="https://github.com/influxdata/telegraf"><strong>Telegraf</strong></a> is an awesome tool to
extract metrics.</p>
<p>You can customize what data to extract and how <strong>Telegraf</strong> will do that by
providing a <code>telegraf.conf</code> file. The one we'll be using is this one:</p>
<pre><code class="language-conf" data-lang="conf">[[inputs.net]]
  interfaces = [&quot;eth0,eth1,lo&quot;]

[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false

[[inputs.disk]]
  ignore_fs = [&quot;tmpfs&quot;, &quot;devtmpfs&quot;]

[[inputs.diskio]]

[[inputs.kernel]]

[[inputs.mem]]

[[inputs.processes]]

[[inputs.swap]]
[[inputs.system]]
[[inputs.netstat]]

[[inputs.docker]]
  endpoint = &quot;unix:///var/run/docker.sock&quot;
  container_names = []
  timeout = &quot;5s&quot;
  perdevice = true
  total = false
  docker_label_include = []
  docker_label_exclude = []

[[outputs.influxdb]]
  urls = [&quot;http://influxdb:8086&quot;]
  database = &quot;telegraf&quot;
  retention_policy = &quot;&quot;
  write_consistency = &quot;any&quot;
  timeout = &quot;5s&quot;
</code></pre><p>If you want to get the default <strong>Telegraf</strong> config (with all options commented)
you can use the following command to get it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker pull telegraf:1.4.0-alpine
docker run --rm telegraf:1.4.0-alpine telegraf config &gt; telegraf.conf
</code></pre></div><p>After getting a <code>telegraf.conf</code> file, we're able to define our service
configuration in <code>docker-compose.yml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">version: <span style="color:#e6db74">&#34;3.3&#34;</span>

services:
  telegraf:
    image: telegraf:<span style="color:#ae81ff">1.4</span><span style="color:#ae81ff">.0</span>
    hostname: <span style="color:#e6db74">&#34;{{.Node.ID}}&#34;</span>
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    configs:
      - source: telegraf.conf
        target: /etc/telegraf/telegraf.conf
    deploy:
      mode: global

configs:
  telegraf.conf:
    file: ./telegraf/telegraf.conf
</code></pre></div><p>It's pretty simple. The trick here is to add <code>deploy mode</code> as <strong><code>global</code></strong>. This
will make <strong>Telegraf</strong> run on every machine in <strong>Swarm</strong> cluster, and that's how
we're going to be able to monitor the cluster machines.</p>
<blockquote>
<p>We're not using Telegraf's Alpine image because Alpine doesn't include
all the dependencies to be able to collect <code>[[inputs.system]]</code>.</p>
</blockquote>
<h2 id="influxdb">InfluxDB</h2>
<p><a href="https://github.com/influxdata/influxdb"><strong>InfluxDB</strong></a> is a time series database
that allows us to store the metrics provided by <strong>Telegraf</strong>.</p>
<p>As <strong>InfluxDB</strong> is our database, we'll first need to define where it would be
located. As we'll need the data to be persistent, it's a bad idea to have the
database popping out in different places (and, as a consequence, losing the
data if it's deployed to a newer place). So, grab one of your swarm nodes and
add a label to it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker node update --label-add influxdb<span style="color:#f92672">=</span>true &lt;NODE-ID&gt;
</code></pre></div><p>This will add the node <code>influxdb</code> with value as <code>true</code> to the node <code>NODE-ID</code>.
It'll be used to know where we can add <code>influxdb</code> container.</p>
<p>Then, we'll also be able to provide a configuration file, named <code>influxdb.conf</code>.
<strong>InfluxDB</strong> also provides a way to get a config file template by running:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run --rm influxdb:1.3.5-alpine influxd config &gt; influxdb.conf
</code></pre></div><p>Then, we can declare the <code>influxdb</code> service:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">services:
  influxdb:
    image: influxdb:<span style="color:#ae81ff">1.3</span><span style="color:#ae81ff">.5</span>-alpine
    configs:
      - source: influxdb.conf
        target: /etc/influxdb/influxdb.conf
    volumes:
      - /data/influxdb:/var/lib/influxdb
    deploy:
      placement:
        constraints:
          - node.labels.influxdb == <span style="color:#66d9ef">true</span>

configs:
  influxdb.conf:
    file: ./influxdb/influxdb.conf
</code></pre></div><p>We'll use the following <code>influxdb.conf</code> file:</p>
<pre><code class="language-conf" data-lang="conf">[meta]
  dir = &quot;/var/lib/influxdb/meta&quot;
  retention-autocreate = true
  logging-enabled = true

[data]
  dir = &quot;/var/lib/influxdb/data&quot;
  index-version = &quot;inmem&quot;
  wal-dir = &quot;/var/lib/influxdb/wal&quot;
  wal-fsync-delay = &quot;0s&quot;
  query-log-enabled = true
  cache-max-memory-size = 1073741824
  cache-snapshot-memory-size = 26214400
  cache-snapshot-write-cold-duration = &quot;10m0s&quot;
  compact-full-write-cold-duration = &quot;4h0m0s&quot;
  max-series-per-database = 1000000
  max-values-per-tag = 100000
  max-concurrent-compactions = 0
  trace-logging-enabled = false

[http]
  enabled = true
  bind-address = &quot;:8086&quot;
  auth-enabled = false
  log-enabled = true
  write-tracing = false
  pprof-enabled = true
  https-enabled = false
  https-certificate = &quot;/etc/ssl/influxdb.pem&quot;
  https-private-key = &quot;&quot;
  max-row-limit = 0
  max-connection-limit = 0
  shared-secret = &quot;&quot;
  realm = &quot;InfluxDB&quot;
  unix-socket-enabled = false
  bind-socket = &quot;/var/run/influxdb.sock&quot;
</code></pre><h2 id="grafana">Grafana</h2>
<p>We'll use <strong>Grafana</strong> to visualize data coming from <strong>InfluxDB</strong>.</p>
<p>First, we'll need to choose a node where we'll be running <strong>Grafana</strong>. After that,
we need to update its label in order to deploy grafana to the correct host:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker node update --label-add grafana<span style="color:#f92672">=</span>true &lt;NODE-ID&gt;
</code></pre></div><p><strong>Grafana</strong> service is pretty straightforward to configure, we just need to add its
service to <code>docker-compose.yml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">services:
  grafana:
    image: grafana/grafana:<span style="color:#ae81ff">4.5</span><span style="color:#ae81ff">.2</span>
    ports:
      - <span style="color:#ae81ff">3000</span>:<span style="color:#ae81ff">3000</span>
    volumes:
      - /data/grafana:/var/lib/grafana
    deploy:
      placement:
        constraints:
          - node.labels.grafana == <span style="color:#66d9ef">true</span>
</code></pre></div><h2 id="deployment-time">Deployment Time!</h2>
<p>It's time to deploy our monitoring stack. To do so, we'll use <code>docker stack</code>
command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker stack deploy -c docker-compose.yml MONITORING
</code></pre></div><p>You can check if your stack is running by typing:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker stack services MONITORING
</code></pre></div><p>You should see something like the following:</p>
<pre><code>ID                  NAME                  MODE                REPLICAS            IMAGE                   PORTS
a9l5bzodswai        MONITORING_grafana    replicated          1/1                 grafana/grafana:4.5.2   *:3000-&gt;3000/tcp
vmrob3iveofr        MONITORING_telegraf   global              1/1                 telegraf:1.4.0-alpine
wllxmffrsxd7        MONITORING_influxdb   replicated          1/1                 influxdb:1.3.5-alpine
</code></pre><h3 id="configuring-grafana">Configuring Grafana</h3>
<p>Now, it's time to configure a new <code>Data Source</code>. Go to <strong>Grafana</strong> admin page
(http://localhost:3000) and create a new <code>Data Source</code> with the following
fields:</p>
<ul>
<li>Name: <code>InfluxDB</code></li>
<li>Type: <code>InfluxDB</code></li>
<li>Http settings:
<ul>
<li>Url: <code>http://influxdb:8086</code> (<code>Swarm</code> provides a DNS for us)</li>
<li>Access: <code>proxy</code></li>
</ul>
</li>
<li>InfluxDB Details:
<ul>
<li>Database: <code>telegraf</code></li>
</ul>
</li>
</ul>
<p>Then, we can create our dashboards and add data to them. If you don't know where
to start, there are some nice dashboards in <a href="https://grafana.com/dashboards">https://grafana.com/dashboards</a>. The
following dashboards are nice ones to use with <strong>Docker Swarm</strong>:</p>
<ul>
<li><a href="https://grafana.com/dashboards/1443">https://grafana.com/dashboards/1443</a></li>
<li><a href="https://grafana.com/dashboards/1150">https://grafana.com/dashboards/1150</a></li>
</ul>
<p>Now, you'll have a nice and powerful monitoring stack for your Docker containers
and for your machines!</p>
<p>Hope you enjoyed!</p>

      </article>

      <p class="post-meta">Tags:&nbsp;
        
            
            <a href="https://wmartins.github.io/tags/docker">docker</a>
        
            ,&nbsp;
            <a href="https://wmartins.github.io/tags/docker%20swarm">docker swarm</a>
        
            ,&nbsp;
            <a href="https://wmartins.github.io/tags/grafana">grafana</a>
        
            ,&nbsp;
            <a href="https://wmartins.github.io/tags/influxdb">influxdb</a>
        
            ,&nbsp;
            <a href="https://wmartins.github.io/tags/telegraf">telegraf</a>
        
            ,&nbsp;
            <a href="https://wmartins.github.io/tags/monitoring">monitoring</a>
        
      </p>

      

    </div>
  </div>
</div>
    <footer class="footer">
      <div class="p2 wrap">
        <div class="measure mt1 center">
      <nav class="social-icons icons">
<a class="fa fa-rss rss" href="/index.xml"></a>

</nav>

          <small>
            Copyright &#169; 2017<br>
            Powered by <a href="http://gohugo.io/" target="_blank">Hugo</a> &amp; <a href="https://github.com/azmelanar/hugo-theme-pixyll" target="_blank">Pixyll</a>
          </small>
        </div>
      </div>
    </footer>

    
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-68493929-1', 'auto');
  ga('send', 'pageview');

</script>



</body>
</html>

