<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.85333577aa7dbfd7b7d3.css">code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.20.24"/><title data-react-helmet="true">Creating a Monitoring Stack With Docker Swarm, Grafana, InfluxDB and Telegraf | wwwhmartins</title><meta data-react-helmet="true" name="description" content="William Martins on the web, I guess"/><meta data-react-helmet="true" property="og:title" content="Creating a Monitoring Stack With Docker Swarm, Grafana, InfluxDB and Telegraf"/><meta data-react-helmet="true" property="og:description" content="William Martins on the web, I guess"/><meta data-react-helmet="true" property="og:type" content="website"/><link as="script" rel="preload" href="/webpack-runtime-a94bffe061c628227522.js"/><link as="script" rel="preload" href="/framework-37b45856124a722f0eb5.js"/><link as="script" rel="preload" href="/styles-1bb458fe328f2ce5df8e.js"/><link as="script" rel="preload" href="/app-c61586ac2be7065d88c8.js"/><link as="script" rel="preload" href="/8404b144cf2ad46e7de17bf4d936317e474a8ae6-7c7ec56f86e20063ce79.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-24dbe2447771bd760dc7.js"/><link as="fetch" rel="preload" href="/page-data/2017/10/creating-a-monitoring-stack-with-docker-swarm-grafana-influxdb-and-telegraf/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.body.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion-css="c4f9ew">body{color:var(--theme-ui-colors-text,#000);background-color:var(--theme-ui-colors-background,#fff);}</style><style data-emotion-css="1q7li8i">*{box-sizing:border-box;}body{margin:0;font-family:Georgia,serif;line-height:1.5;font-weight:400;font-size:18px;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="u1ld3h">.css-u1ld3h{box-sizing:border-box;margin:0;min-width:0;width:100%;max-width:1024px;margin-left:auto;margin-right:auto;padding:32px;}</style><div class="css-u1ld3h"><style data-emotion-css="1je9rmk">.css-1je9rmk{font-family:Georgia,serif;line-height:1.5;font-weight:400;}.css-1je9rmk root{font-family:Georgia,serif;line-height:1.5;font-weight:400;font-size:18px;}.css-1je9rmk h1{color:var(--theme-ui-colors-text,#000);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.125;font-weight:700;font-size:32px;}.css-1je9rmk h2{color:var(--theme-ui-colors-text,#000);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.125;font-weight:700;font-size:24px;}.css-1je9rmk h3{color:var(--theme-ui-colors-text,#000);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.125;font-weight:700;font-size:20px;}.css-1je9rmk h4{color:var(--theme-ui-colors-text,#000);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.125;font-weight:700;font-size:16px;}.css-1je9rmk h5{color:var(--theme-ui-colors-text,#000);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.125;font-weight:700;font-size:14px;}.css-1je9rmk h6{color:var(--theme-ui-colors-text,#000);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.125;font-weight:700;font-size:12px;}.css-1je9rmk p{color:var(--theme-ui-colors-text,#000);font-family:Georgia,serif;font-weight:400;line-height:1.5;}.css-1je9rmk a{color:var(--theme-ui-colors-primary,#07c);display:inline-block;}.css-1je9rmk pre{font-family:Menlo,monospace;overflow-x:auto;}.css-1je9rmk pre code{color:inherit;}.css-1je9rmk code{font-family:Menlo,monospace;font-size:inherit;}.css-1je9rmk table{width:100%;border-collapse:separate;border-spacing:0;}.css-1je9rmk th{text-align:left;border-bottom-style:solid;}.css-1je9rmk td{text-align:left;border-bottom-style:solid;}.css-1je9rmk img{max-width:100%;}.css-1je9rmk time{color:gray;font-size:14px;}.css-1je9rmk hr{color:var(--theme-ui-colors-muted,#eeeeee);}</style><div class="css-1je9rmk"><header><style data-emotion-css="13sy603">.css-13sy603{box-sizing:border-box;margin:0;min-width:0;padding-bottom:32px;}</style><nav class="css-13sy603"><style data-emotion-css="1a8yp2e">.css-1a8yp2e{box-sizing:border-box;margin:0;min-width:0;padding-right:32px;}</style><a class="css-1a8yp2e" href="/">wwwhmartins</a><a class="css-1a8yp2e" href="/tags">tags</a><a class="css-1a8yp2e" href="/about">about</a><a class="css-1a8yp2e" href="/contact">contact</a></nav></header><style data-emotion-css="1q5mv8c">.css-1q5mv8c{box-sizing:border-box;margin:0;min-width:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;font-weight:700;line-height:1.125;}</style><h1 class="css-1q5mv8c">Creating a Monitoring Stack With Docker Swarm, Grafana, InfluxDB and Telegraf</h1><div><p>Monitoring your infrastructure is one of the most important aspects of
successfully launching a product. It's really important to know when your
machines/applications are under heavy load. Moreover, if it happens, you would
want to quickly know what's going on and what you can do to recover your
infrastructure.</p>
<p>This blog post explains how you can configure setup a monitoring stack easily
using <a href="https://docs.docker.com/engine/swarm/"><strong>Docker Swarm</strong></a>,
<a href="https://github.com/grafana/grafana"><strong>Grafana</strong></a>,
<a href="https://github.com/influxdata/influxdb"><strong>InfluxDB</strong></a> and
<a href="https://github.com/influxdata/telegraf"><strong>Telegraf</strong></a>.</p>
<h2>Docker Swarm</h2>
<p>This tutorial requires you to be running a <strong>Swarm cluster</strong>. You can also setup
this monitoring infrastructure without using Swarm, but it might become hard to
manage when you add or remove nodes on your cluster.</p>
<blockquote>
<p>You can achieve the same using another deployment/orchestration tool, like
<a href="https://www.nomadproject.io/"><strong>Nomad</strong></a>.</p>
</blockquote>
<p>We'll be using the version <strong>3.3</strong> of <code class="language-text">docker-compose.yml</code> file.</p>
<h2>Telegraf</h2>
<p><a href="https://github.com/influxdata/telegraf"><strong>Telegraf</strong></a> is an awesome tool to
extract metrics.</p>
<p>You can customize what data to extract and how <strong>Telegraf</strong> will do that by
providing a <code class="language-text">telegraf.conf</code> file. The one we'll be using is this one:</p>
<div class="gatsby-highlight" data-language="conf"><pre class="language-conf"><code class="language-conf">[[inputs.net]]
  interfaces = [&quot;eth0,eth1,lo&quot;]

[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false

[[inputs.disk]]
  ignore_fs = [&quot;tmpfs&quot;, &quot;devtmpfs&quot;]

[[inputs.diskio]]

[[inputs.kernel]]

[[inputs.mem]]

[[inputs.processes]]

[[inputs.swap]]
[[inputs.system]]
[[inputs.netstat]]

[[inputs.docker]]
  endpoint = &quot;unix:///var/run/docker.sock&quot;
  container_names = []
  timeout = &quot;5s&quot;
  perdevice = true
  total = false
  docker_label_include = []
  docker_label_exclude = []

[[outputs.influxdb]]
  urls = [&quot;http://influxdb:8086&quot;]
  database = &quot;telegraf&quot;
  retention_policy = &quot;&quot;
  write_consistency = &quot;any&quot;
  timeout = &quot;5s&quot;</code></pre></div>
<p>If you want to get the default <strong>Telegraf</strong> config (with all options commented)
you can use the following command to get it:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">docker pull telegraf:1.4.0-alpine
docker run --rm telegraf:1.4.0-alpine telegraf config <span class="token operator">></span> telegraf.conf</code></pre></div>
<p>After getting a <code class="language-text">telegraf.conf</code> file, we're able to define our service
configuration in <code class="language-text">docker-compose.yml</code>:</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.3"</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">telegraf</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> telegraf<span class="token punctuation">:</span>1.4.0
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> <span class="token string">"{{.Node.ID}}"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/var/run/docker.sock
    <span class="token key atrule">configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span> telegraf.conf
        <span class="token key atrule">target</span><span class="token punctuation">:</span> /etc/telegraf/telegraf.conf
    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> global

<span class="token key atrule">configs</span><span class="token punctuation">:</span>
  <span class="token key atrule">telegraf.conf</span><span class="token punctuation">:</span>
    <span class="token key atrule">file</span><span class="token punctuation">:</span> ./telegraf/telegraf.conf</code></pre></div>
<p>It's pretty simple. The trick here is to add <code class="language-text">deploy mode</code> as <strong><code class="language-text">global</code></strong>. This
will make <strong>Telegraf</strong> run on every machine in <strong>Swarm</strong> cluster, and that's how
we're going to be able to monitor the cluster machines.</p>
<blockquote>
<p>We're not using Telegraf's Alpine image because Alpine doesn't include
all the dependencies to be able to collect <code class="language-text">[[inputs.system]]</code>.</p>
</blockquote>
<h2>InfluxDB</h2>
<p><a href="https://github.com/influxdata/influxdb"><strong>InfluxDB</strong></a> is a time series database
that allows us to store the metrics provided by <strong>Telegraf</strong>.</p>
<p>As <strong>InfluxDB</strong> is our database, we'll first need to define where it would be
located. As we'll need the data to be persistent, it's a bad idea to have the
database popping out in different places (and, as a consequence, losing the
data if it's deployed to a newer place). So, grab one of your swarm nodes and
add a label to it:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">docker node update --label-add <span class="token assign-left variable">influxdb</span><span class="token operator">=</span>true <span class="token operator">&lt;</span>NODE-ID<span class="token operator">></span></code></pre></div>
<p>This will add the node <code class="language-text">influxdb</code> with value as <code class="language-text">true</code> to the node <code class="language-text">NODE-ID</code>.
It'll be used to know where we can add <code class="language-text">influxdb</code> container.</p>
<p>Then, we'll also be able to provide a configuration file, named <code class="language-text">influxdb.conf</code>.
<strong>InfluxDB</strong> also provides a way to get a config file template by running:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">docker run --rm influxdb:1.3.5-alpine influxd config <span class="token operator">></span> influxdb.conf</code></pre></div>
<p>Then, we can declare the <code class="language-text">influxdb</code> service:</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">influxdb</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> influxdb<span class="token punctuation">:</span>1.3.5<span class="token punctuation">-</span>alpine
    <span class="token key atrule">configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span> influxdb.conf
        <span class="token key atrule">target</span><span class="token punctuation">:</span> /etc/influxdb/influxdb.conf
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/influxdb<span class="token punctuation">:</span>/var/lib/influxdb
    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
      <span class="token key atrule">placement</span><span class="token punctuation">:</span>
        <span class="token key atrule">constraints</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> node.labels.influxdb == true

<span class="token key atrule">configs</span><span class="token punctuation">:</span>
  <span class="token key atrule">influxdb.conf</span><span class="token punctuation">:</span>
    <span class="token key atrule">file</span><span class="token punctuation">:</span> ./influxdb/influxdb.conf</code></pre></div>
<p>We'll use the following <code class="language-text">influxdb.conf</code> file:</p>
<div class="gatsby-highlight" data-language="conf"><pre class="language-conf"><code class="language-conf">[meta]
  dir = &quot;/var/lib/influxdb/meta&quot;
  retention-autocreate = true
  logging-enabled = true

[data]
  dir = &quot;/var/lib/influxdb/data&quot;
  index-version = &quot;inmem&quot;
  wal-dir = &quot;/var/lib/influxdb/wal&quot;
  wal-fsync-delay = &quot;0s&quot;
  query-log-enabled = true
  cache-max-memory-size = 1073741824
  cache-snapshot-memory-size = 26214400
  cache-snapshot-write-cold-duration = &quot;10m0s&quot;
  compact-full-write-cold-duration = &quot;4h0m0s&quot;
  max-series-per-database = 1000000
  max-values-per-tag = 100000
  max-concurrent-compactions = 0
  trace-logging-enabled = false

[http]
  enabled = true
  bind-address = &quot;:8086&quot;
  auth-enabled = false
  log-enabled = true
  write-tracing = false
  pprof-enabled = true
  https-enabled = false
  https-certificate = &quot;/etc/ssl/influxdb.pem&quot;
  https-private-key = &quot;&quot;
  max-row-limit = 0
  max-connection-limit = 0
  shared-secret = &quot;&quot;
  realm = &quot;InfluxDB&quot;
  unix-socket-enabled = false
  bind-socket = &quot;/var/run/influxdb.sock&quot;</code></pre></div>
<h2>Grafana</h2>
<p>We'll use <strong>Grafana</strong> to visualize data coming from <strong>InfluxDB</strong>.</p>
<p>First, we'll need to choose a node where we'll be running <strong>Grafana</strong>. After that,
we need to update its label in order to deploy grafana to the correct host:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">docker node update --label-add <span class="token assign-left variable">grafana</span><span class="token operator">=</span>true <span class="token operator">&lt;</span>NODE-ID<span class="token operator">></span></code></pre></div>
<p><strong>Grafana</strong> service is pretty straightforward to configure, we just need to add its
service to <code class="language-text">docker-compose.yml</code>:</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">grafana</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/grafana<span class="token punctuation">:</span>4.5.2
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 3000<span class="token punctuation">:</span><span class="token number">3000</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/grafana<span class="token punctuation">:</span>/var/lib/grafana
    <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
      <span class="token key atrule">placement</span><span class="token punctuation">:</span>
        <span class="token key atrule">constraints</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> node.labels.grafana == true</code></pre></div>
<h2>Deployment Time!</h2>
<p>It's time to deploy our monitoring stack. To do so, we'll use <code class="language-text">docker stack</code>
command:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">docker stack deploy -c docker-compose.yml MONITORING</code></pre></div>
<p>You can check if your stack is running by typing:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">docker stack services MONITORING</code></pre></div>
<p>You should see something like the following:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">ID                  NAME                  MODE                REPLICAS            IMAGE                   PORTS
a9l5bzodswai        MONITORING_grafana    replicated          1/1                 grafana/grafana:4.5.2   *:3000-&gt;3000/tcp
vmrob3iveofr        MONITORING_telegraf   global              1/1                 telegraf:1.4.0-alpine
wllxmffrsxd7        MONITORING_influxdb   replicated          1/1                 influxdb:1.3.5-alpine</code></pre></div>
<h3>Configuring Grafana</h3>
<p>Now, it's time to configure a new <code class="language-text">Data Source</code>. Go to <strong>Grafana</strong> admin page
(<a href="http://localhost:3000">http://localhost:3000</a>) and create a new <code class="language-text">Data Source</code> with the following
fields:</p>
<ul>
<li>Name: <code class="language-text">InfluxDB</code></li>
<li>Type: <code class="language-text">InfluxDB</code></li>
<li>
<p>Http settings:</p>
<ul>
<li>Url: <code class="language-text">http://influxdb:8086</code> (<code class="language-text">Swarm</code> provides a DNS for us)</li>
<li>Access: <code class="language-text">proxy</code></li>
</ul>
</li>
<li>
<p>InfluxDB Details:</p>
<ul>
<li>Database: <code class="language-text">telegraf</code></li>
</ul>
</li>
</ul>
<p>Then, we can create our dashboards and add data to them. If you don't know where
to start, there are some nice dashboards in <a href="https://grafana.com/dashboards">https://grafana.com/dashboards</a>. The
following dashboards are nice ones to use with <strong>Docker Swarm</strong>:</p>
<ul>
<li><a href="https://grafana.com/dashboards/1443">https://grafana.com/dashboards/1443</a></li>
<li><a href="https://grafana.com/dashboards/1150">https://grafana.com/dashboards/1150</a></li>
</ul>
<p>Now, you'll have a nice and powerful monitoring stack for your Docker containers
and for your machines!</p>
<p>Hope you enjoyed!</p></div><style data-emotion-css="1jvijmd">.css-1jvijmd{box-sizing:border-box;margin:0;min-width:0;color:gray;margin:0;margin-top:8px;margin-bottom:8px;border:0;border-bottom:1px solid;color:var(--theme-ui-colors-muted,#eeeeee);}</style><hr class="css-1jvijmd"/>Tags:<style data-emotion-css="1k3micg">.css-1k3micg{box-sizing:border-box;margin:0;min-width:0;padding-left:8px;}</style><a class="css-1k3micg" href="/tags/docker">docker</a><a class="css-1k3micg" href="/tags/docker-swarm">docker swarm</a><a class="css-1k3micg" href="/tags/grafana">grafana</a><a class="css-1k3micg" href="/tags/influxdb">influxdb</a><a class="css-1k3micg" href="/tags/telegraf">telegraf</a><a class="css-1k3micg" href="/tags/monitoring">monitoring</a></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2017/10/creating-a-monitoring-stack-with-docker-swarm-grafana-influxdb-and-telegraf/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-c61586ac2be7065d88c8.js"],"component---src-pages-index-js":["/component---src-pages-index-js-59351d248b3e7b55c49d.js"],"component---src-pages-tags-js":["/component---src-pages-tags-js-bb6069ca8e5b60e8d89a.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-24dbe2447771bd760dc7.js"],"component---src-templates-tags-js":["/component---src-templates-tags-js-c9d19b7cde892151dba8.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-24dbe2447771bd760dc7.js" async=""></script><script src="/8404b144cf2ad46e7de17bf4d936317e474a8ae6-7c7ec56f86e20063ce79.js" async=""></script><script src="/app-c61586ac2be7065d88c8.js" async=""></script><script src="/styles-1bb458fe328f2ce5df8e.js" async=""></script><script src="/framework-37b45856124a722f0eb5.js" async=""></script><script src="/webpack-runtime-a94bffe061c628227522.js" async=""></script></body></html>