<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.85333577aa7dbfd7b7d3.css">code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.20.24"/><title data-react-helmet="true">The Lost Callback | wwwhmartins</title><meta data-react-helmet="true" name="description" content="William Martins on the web, I guess"/><meta data-react-helmet="true" property="og:title" content="The Lost Callback"/><meta data-react-helmet="true" property="og:description" content="William Martins on the web, I guess"/><meta data-react-helmet="true" property="og:type" content="website"/><link as="script" rel="preload" href="/webpack-runtime-23591cc8e0ec01743664.js"/><link as="script" rel="preload" href="/framework-37b45856124a722f0eb5.js"/><link as="script" rel="preload" href="/styles-1bb458fe328f2ce5df8e.js"/><link as="script" rel="preload" href="/app-b71fb930d96e0b01e779.js"/><link as="script" rel="preload" href="/8404b144cf2ad46e7de17bf4d936317e474a8ae6-7c7ec56f86e20063ce79.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-16696327739dce1d292a.js"/><link as="fetch" rel="preload" href="/page-data/2019/01/the-lost-callback/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.body.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion-css="c4f9ew">body{color:var(--theme-ui-colors-text,#000);background-color:var(--theme-ui-colors-background,#fff);}</style><style data-emotion-css="l12f6i">*{box-sizing:border-box;}body{margin:0;font-family:Georgia,serif;line-height:1.5;font-weight:400;font-size:20px;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="u1ld3h">.css-u1ld3h{box-sizing:border-box;margin:0;min-width:0;width:100%;max-width:1024px;margin-left:auto;margin-right:auto;padding:32px;}</style><div class="css-u1ld3h"><style data-emotion-css="uijd1d">.css-uijd1d{font-family:Georgia,serif;line-height:1.5;font-weight:400;}.css-uijd1d root{font-family:Georgia,serif;line-height:1.5;font-weight:400;font-size:20px;}.css-uijd1d h1{color:var(--theme-ui-colors-text,#000);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.125;font-weight:700;font-size:32px;}.css-uijd1d h2{color:var(--theme-ui-colors-text,#000);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.125;font-weight:700;font-size:24px;}.css-uijd1d h3{color:var(--theme-ui-colors-text,#000);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.125;font-weight:700;font-size:20px;}.css-uijd1d h4{color:var(--theme-ui-colors-text,#000);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.125;font-weight:700;font-size:16px;}.css-uijd1d h5{color:var(--theme-ui-colors-text,#000);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.125;font-weight:700;font-size:14px;}.css-uijd1d h6{color:var(--theme-ui-colors-text,#000);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.125;font-weight:700;font-size:12px;}.css-uijd1d p{color:var(--theme-ui-colors-text,#000);font-family:Georgia,serif;font-weight:400;line-height:1.5;}.css-uijd1d a{color:var(--theme-ui-colors-primary,#07c);display:inline-block;}.css-uijd1d pre{font-family:Menlo,monospace;overflow-x:auto;}.css-uijd1d pre code{color:inherit;}.css-uijd1d code{font-family:Menlo,monospace;font-size:inherit;}.css-uijd1d table{width:100%;border-collapse:separate;border-spacing:0;}.css-uijd1d th{text-align:left;border-bottom-style:solid;}.css-uijd1d td{text-align:left;border-bottom-style:solid;}.css-uijd1d img{max-width:100%;}.css-uijd1d time{color:gray;font-size:14px;}.css-uijd1d hr{color:var(--theme-ui-colors-muted,#eeeeee);}.css-uijd1d nav{font-size:18px;}</style><div class="css-uijd1d"><header><style data-emotion-css="13sy603">.css-13sy603{box-sizing:border-box;margin:0;min-width:0;padding-bottom:32px;}</style><nav class="css-13sy603"><style data-emotion-css="1a8yp2e">.css-1a8yp2e{box-sizing:border-box;margin:0;min-width:0;padding-right:32px;}</style><a class="css-1a8yp2e" href="/">wwwhmartins</a><a class="css-1a8yp2e" href="/tags">tags</a><a class="css-1a8yp2e" href="/about">about</a><a class="css-1a8yp2e" href="/contact">contact</a></nav></header><style data-emotion-css="1q5mv8c">.css-1q5mv8c{box-sizing:border-box;margin:0;min-width:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;font-weight:700;line-height:1.125;}</style><h1 class="css-1q5mv8c">The Lost Callback</h1><div><p>In the past few days I was investigating a really tricky issue in one of our
React components. I decided to cover it here because I've found the problem
interesting and, surprisingly, easy to fix after finding out the root cause.</p>
<h1>The Component</h1>
<p>First, it's nice to outline a little bit about the component itself. It's a
really simple react component that does the following things:</p>
<ol>
<li>When the component mounts, inserts a <code class="language-text">&lt;script&gt;</code> tag on the page to load an
external dependency</li>
<li>When this script is loaded, instantiate a new instance of this external
dependency</li>
<li>Renders correctly both when script is loaded and when it isn't</li>
<li>When removing the component, destroys the external dependency instance</li>
</ol>
<p>So, that said, lets jump into the parts that make it happen.</p>
<p>First, we have the script loader function, which is pretty straightforward:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">addScriptToPage</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> src</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    script<span class="token punctuation">.</span>defer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>onload <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>

    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The component itself is also pretty straightforward:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">TheComponent</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            externalDependency<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addScriptToPage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> externalDependency <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExternalDependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            externalDependency<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                externalDependency<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'external.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> externalDependency <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>

        externalDependency <span class="token operator">&amp;&amp;</span> externalDependency<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> externalDependency <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> externalDependency
            <span class="token operator">?</span>  externalDependency<span class="token punctuation">.</span><span class="token function">doStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token string">'NOT LOADED YET'</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">External value: </span><span class="token punctuation">{</span>value<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            hide<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
                hide<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hide<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">TheComponent</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The external dependency, for all the purposes, is just a library. In our case,
the real one listens to some events and some other stuff. For this post,
consider the following external dependency:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">ExternalDependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">create</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            window<span class="token punctuation">.</span><span class="token constant">EXTERNAL</span> <span class="token operator">=</span> <span class="token string">'EXTERNAL'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token function-variable function">doStuff</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token function-variable function">destroy</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">delete</span> window<span class="token punctuation">.</span><span class="token constant">EXTERNAL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h1>The Problem</h1>
<p>The problem given was the following:</p>
<blockquote>
<p>When we include the component on the page and, right afterwards remove it from
the page, the component throws an error and the page stops working.</p>
</blockquote>
<p>Alongside with the error description, we also had the following log:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">TypeError: this.state.externalDependency is null</code></pre></div>
<h1>The Test Setup</h1>
<p>So, in order to test this problem, we need to simulate this "right afterwards"
behavior. To do so, we'll render the component on the page, set a timeout (a
short one) and remove the component from the screen.</p>
<p>Consider the following code:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            hide<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
                hide<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hide<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">TheComponent</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h1>The Investigation</h1>
<p><strong>Disclaimer:</strong> now that I'm explaining this in a blog post, the problem seems
obvious to me. I think this is because the code shown here is really simplified. The real code has some messy parts, some reducers and lots of code that only
made the investigation progress harder.</p>
<p>Looking at the code, we can see that the only place where
<code class="language-text">this.state.externalDependency</code> can cause this error is inside
<code class="language-text">componentWillUnmount</code>, because it starts as <code class="language-text">null</code>. So, what happens is that
the script hasn't finished loading and we're trying to destroy the instance
(that doesn't exist yet).</p>
<p>So, it might be tempting to do the following:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> externalDependency <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>externalDependency<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    externalDependency<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>It will make the page stop breaking, as now we don't have a <code class="language-text">TypeError</code>,
however, we will start having this error:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Warning: Can&#39;t perform a React state update on an unmounted component. This is a no-op, but it indicates a memory leak in your application. To fix, cancel all subscriptions and asynchronous tasks in the componentWillUnmount method.</code></pre></div>
<p>You might think that it's only a <code class="language-text">Warning</code> and we're good to go, however, that's
not how things work. Now, we <strong>never</strong> call <code class="language-text">externalDependency.destroy()</code>, so,
we never clear the changes done by <code class="language-text">externalDependency</code>. In fact, if we now
check <code class="language-text">window.EXTERNAL</code>, we'll have it with the value <code class="language-text">&quot;EXTERNAL&quot;</code>.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">window<span class="token punctuation">.</span><span class="token constant">EXTERNAL</span><span class="token punctuation">;</span> <span class="token comment">// "EXTERNAL"</span></code></pre></div>
<h2>Making It Clear</h2>
<p>So, let's recap what's going on, before exploring the solution:</p>
<ol>
<li>The component is rendered on the page</li>
<li>The script pointing to <code class="language-text">external.js</code> is created on the page, a callback is
registered to, when the script loads, instantiate an instance of
<code class="language-text">ExternalDependency</code></li>
<li>The component is removed</li>
<li>The <code class="language-text">componentWillUnmount</code> is triggered (not calling
<code class="language-text">externalDependency.destroy()</code>, as it wasn't instantiated so far)</li>
<li>The component is removed from the DOM</li>
<li>The script finishes loading</li>
<li>The callback defined in <code class="language-text">2.</code> is executed</li>
<li>The external dependency is instantiated</li>
<li>The component tries to <code class="language-text">setState</code> in an unmounted component, which explains
the error before</li>
</ol>
<h1>The Solution</h1>
<p>While it can be tempting to put something on <code class="language-text">componentWillUnmount</code>, like a
<code class="language-text">setState</code> or so, it is not correct and also doesn't make sense.
<code class="language-text">componentWillUnmount</code> is called when the component is just about to be removed,
there's no "hey React, wait a little bit so I can make some stuff here
and I let you know when you can remove me". Also, setting a state on a component
to be unmounted doesn't make sense, as this component is being removed, it will
not render again nor go to any other <code class="language-text">lifecycle</code> methods.</p>
<h2>Solution 1: Know When Unmounted</h2>
<p>One solution that I particularly <strong>don't like</strong> is to have an instance property in
your component that allows you to know if the component is being unmounted.
Something like that:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isUnmounted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">/* ... remaining code ... */</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Then, add a guard condition in your code to avoid the callback to run in this
case:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">addScriptToPage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isUnmounted<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token comment">/* ... remaining code ... */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>This works, however, imagine that in some new update, the React team decides to
clear all instance properties (our <code class="language-text">isUnmounted</code> included). We now have our
memory leak again. Basically, with this solution, we're relying on React to set
a property for us and set it in the correct moment, which gives us less control
of our code flow.</p>
<h2>Solution 2: Control When to Execute the <code class="language-text">onload</code> Callback</h2>
<p>Our final solution and, in my opinion, a most elegant one, is to have an option
to cancel the execution of our script loader. Our problem is that the <code class="language-text">onload</code>
callback is being called after the component is unmounted, so, if we never call
this callback, we'll not have this problem.</p>
<p>In this case, we can do something like that:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">addScriptToPage</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> src</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    script<span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>defer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>onload <span class="token operator">=</span> callback<span class="token punctuation">;</span>

    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">cancelOnLoad</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> script<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Now, in our component, we need to hold a reference to this returned object when
calling <code class="language-text">addScriptToPage</code>:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> scriptLoader <span class="token operator">=</span> <span class="token function">addScriptToPage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token comment">/* remaining code */</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> scriptLoader <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Then, when unmounting, we just call <code class="language-text">cancelOnLoad</code>:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* remaining code */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>scriptLoader<span class="token punctuation">.</span><span class="token function">cancelOnLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This is a lot better, as now we manage this flow. For example, it's also
possible to remove the previously defined script (and save some bytes of our
users data):</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">cancelOnLoad</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        script<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<h1>Finishing</h1>
<p>I think this problem was really interesting to show me how a simple script
loader can become a hard problem to debug if we don't think correctly in the
flow which our code is executed.</p>
<p>Also, always remember to cancel/clear stuff, specially the async ones, to avoid
having those kind of problems.</p></div><style data-emotion-css="1jvijmd">.css-1jvijmd{box-sizing:border-box;margin:0;min-width:0;color:gray;margin:0;margin-top:8px;margin-bottom:8px;border:0;border-bottom:1px solid;color:var(--theme-ui-colors-muted,#eeeeee);}</style><hr class="css-1jvijmd"/><style data-emotion-css="bfk5c8">.css-bfk5c8{box-sizing:border-box;margin:0;min-width:0;padding-right:8px;}</style><span class="css-bfk5c8">Tags:</span><a class="css-bfk5c8" href="/tags/react">react</a><a class="css-bfk5c8" href="/tags/async-javascript">async javascript</a></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2019/01/the-lost-callback/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-b71fb930d96e0b01e779.js"],"component---src-pages-index-js":["/component---src-pages-index-js-012a4466067d24326a1c.js"],"component---src-pages-tags-js":["/component---src-pages-tags-js-bb6069ca8e5b60e8d89a.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-16696327739dce1d292a.js"],"component---src-templates-tags-js":["/component---src-templates-tags-js-c9d19b7cde892151dba8.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-16696327739dce1d292a.js" async=""></script><script src="/8404b144cf2ad46e7de17bf4d936317e474a8ae6-7c7ec56f86e20063ce79.js" async=""></script><script src="/app-b71fb930d96e0b01e779.js" async=""></script><script src="/styles-1bb458fe328f2ce5df8e.js" async=""></script><script src="/framework-37b45856124a722f0eb5.js" async=""></script><script src="/webpack-runtime-23591cc8e0ec01743664.js" async=""></script></body></html>